#!/usr/bin/env bash
# symlinks-bootstrap — Manage ticket symlinks in project folders
#
# Creates/swaps symlinks from project folders to tickets/ canonical source.
# One active ticket per project at a time (multiple can be linked).
#
# Usage:
#   symlinks-bootstrap link   <project-path> <ticket-id>    — Link ticket to project
#   symlinks-bootstrap unlink <project-path> <ticket-id>    — Remove ticket symlink
#   symlinks-bootstrap list   <project-path>                — List linked tickets
#   symlinks-bootstrap status                               — Show all ticket links
#
# Examples:
#   symlinks-bootstrap link jha/banno-online WEB-5000
#   symlinks-bootstrap unlink jha/banno-online WEB-4718
#   symlinks-bootstrap list jha/banno-online
#   symlinks-bootstrap status

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
DIM='\033[2m'
NC='\033[0m'

# Root of the workspace
PROJECTS_ROOT="/Users/LenMiller/projects"
TICKETS_DIR="$PROJECTS_ROOT/tickets"

error() { echo -e "${RED}Error: $1${NC}" >&2; exit 1; }
info()  { echo -e "${BLUE}$1${NC}"; }
success() { echo -e "${GREEN}$1${NC}"; }
warn()  { echo -e "${YELLOW}$1${NC}"; }

usage() {
    echo "Usage:"
    echo "  symlinks-bootstrap link   <project-path> <ticket-id>"
    echo "  symlinks-bootstrap unlink <project-path> <ticket-id>"
    echo "  symlinks-bootstrap list   <project-path>"
    echo "  symlinks-bootstrap status"
    echo ""
    echo "Examples:"
    echo "  symlinks-bootstrap link jha/banno-online WEB-5000"
    echo "  symlinks-bootstrap unlink jha/banno-online WEB-4718"
    exit 1
}

# Resolve project path (relative to PROJECTS_ROOT or absolute)
resolve_project() {
    local project="$1"
    if [[ "$project" = /* ]]; then
        echo "$project"
    else
        echo "$PROJECTS_ROOT/$project"
    fi
}

cmd_link() {
    local project_path="$1"
    local ticket_id="$2"

    local project_dir
    project_dir="$(resolve_project "$project_path")"
    local ticket_dir="$TICKETS_DIR/$ticket_id"
    local symlink_path="$project_dir/$ticket_id"

    # Validate project directory exists
    [[ -d "$project_dir" ]] || error "Project directory not found: $project_dir"

    # Create ticket directory if it doesn't exist
    if [[ ! -d "$ticket_dir" ]]; then
        info "Creating ticket directory: $ticket_dir"
        mkdir -p "$ticket_dir"
    fi

    # Check if symlink already exists
    if [[ -L "$symlink_path" ]]; then
        local existing_target
        existing_target="$(readlink "$symlink_path")"
        if [[ "$existing_target" = "$ticket_dir" ]]; then
            warn "$ticket_id is already linked in $project_path"
            return 0
        else
            warn "Symlink exists but points to: $existing_target"
            warn "Updating to: $ticket_dir"
            rm "$symlink_path"
        fi
    elif [[ -e "$symlink_path" ]]; then
        error "$symlink_path exists and is not a symlink — refusing to overwrite"
    fi

    # Create symlink
    ln -s "$ticket_dir" "$symlink_path"
    success "Linked: $project_path/$ticket_id -> tickets/$ticket_id/"
}

cmd_unlink() {
    local project_path="$1"
    local ticket_id="$2"

    local project_dir
    project_dir="$(resolve_project "$project_path")"
    local symlink_path="$project_dir/$ticket_id"

    if [[ ! -L "$symlink_path" ]]; then
        if [[ -e "$symlink_path" ]]; then
            error "$symlink_path is not a symlink — refusing to remove"
        else
            warn "$ticket_id is not linked in $project_path"
            return 0
        fi
    fi

    rm "$symlink_path"
    success "Unlinked: $project_path/$ticket_id"
}

cmd_list() {
    local project_path="$1"
    local project_dir
    project_dir="$(resolve_project "$project_path")"

    [[ -d "$project_dir" ]] || error "Project directory not found: $project_dir"

    info "Ticket links in $project_path:"
    echo ""

    local found=false
    for item in "$project_dir"/*; do
        if [[ -L "$item" ]]; then
            local target
            target="$(readlink "$item")"
            if [[ "$target" == "$TICKETS_DIR"/* ]]; then
                local name
                name="$(basename "$item")"
                echo -e "  ${GREEN}$name${NC} -> ${DIM}$target${NC}"
                found=true
            fi
        fi
    done

    if [[ "$found" = false ]]; then
        echo -e "  ${DIM}(no ticket links)${NC}"
    fi
}

cmd_status() {
    info "All ticket symlinks across projects:"
    echo ""

    local found=false

    # Find all symlinks pointing to tickets/
    while IFS= read -r symlink; do
        local target
        target="$(readlink "$symlink")"
        if [[ "$target" == "$TICKETS_DIR"/* ]]; then
            local rel_path="${symlink#$PROJECTS_ROOT/}"
            local ticket_name
            ticket_name="$(basename "$target")"
            local project_path
            project_path="$(dirname "$rel_path")"
            echo -e "  ${GREEN}$ticket_name${NC}  in  ${BLUE}$project_path${NC}"
            found=true
        fi
    done < <(find "$PROJECTS_ROOT" -maxdepth 4 -type l 2>/dev/null)

    if [[ "$found" = false ]]; then
        echo -e "  ${DIM}(no ticket links found)${NC}"
    fi

    echo ""
    info "Ticket directories:"
    if [[ -d "$TICKETS_DIR" ]]; then
        for ticket in "$TICKETS_DIR"/*/; do
            if [[ -d "$ticket" ]]; then
                local name
                name="$(basename "$ticket")"
                local count
                count="$(find "$ticket" -maxdepth 1 -not -name "$(basename "$ticket")" | wc -l | tr -d ' ')"
                echo -e "  ${GREEN}$name${NC}  ($count items)"
            fi
        done
    else
        echo -e "  ${DIM}(no tickets/ directory)${NC}"
    fi
}

# --- Main ---

[[ $# -ge 1 ]] || usage

case "$1" in
    link)
        [[ $# -eq 3 ]] || error "Usage: symlinks-bootstrap link <project-path> <ticket-id>"
        cmd_link "$2" "$3"
        ;;
    unlink)
        [[ $# -eq 3 ]] || error "Usage: symlinks-bootstrap unlink <project-path> <ticket-id>"
        cmd_unlink "$2" "$3"
        ;;
    list)
        [[ $# -eq 2 ]] || error "Usage: symlinks-bootstrap list <project-path>"
        cmd_list "$2"
        ;;
    status)
        cmd_status
        ;;
    -h|--help|help)
        usage
        ;;
    *)
        error "Unknown command: $1"
        ;;
esac
