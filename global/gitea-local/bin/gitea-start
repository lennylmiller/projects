#!/usr/bin/env bash
# gitea-start - Start Gitea server in background

set -e

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
GITEA_DIR="$(dirname "$SCRIPT_DIR")"
LOG_FILE="$GITEA_DIR/gitea-server.log"
PID_FILE="$GITEA_DIR/.gitea.pid"

# Check if already running
if pgrep -f "gitea web" > /dev/null; then
    echo -e "${YELLOW}Gitea is already running${NC}"
    echo "Use 'gitea-status' to see details"
    exit 0
fi

echo -e "${GREEN}Starting Gitea server...${NC}"

cd "$GITEA_DIR"

# Start in background using nix-shell
nix-shell --run "./start-gitea.sh" > "$LOG_FILE" 2>&1 &
GITEA_PID=$!

# Save PID
echo $GITEA_PID > "$PID_FILE"

# Wait a moment for server to start
sleep 2

# Check if it started successfully
if pgrep -f "gitea web" > /dev/null; then
    ACTUAL_PID=$(pgrep -f "gitea web")
    echo -e "${GREEN}✓ Gitea started successfully${NC}"
    echo ""
    echo "  PID:          $ACTUAL_PID"
    echo "  URL:          http://localhost:3000/"
    echo "  Log file:     $LOG_FILE"
    echo ""
    echo "Commands:"
    echo "  gitea-status  - Check server status"
    echo "  gitea-logs    - View server logs"
    echo "  gitea-stop    - Stop server"
else
    echo -e "${RED}✗ Failed to start Gitea${NC}"
    echo "Check logs: tail $LOG_FILE"
    rm -f "$PID_FILE"
    exit 1
fi
